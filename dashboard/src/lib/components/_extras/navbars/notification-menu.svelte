<script lang="ts">
	import type { ClassValue } from 'svelte/elements';

	import Button from '$lib/components/ui/button.svelte';

	import BellIcon from '@lucide/svelte/icons/bell';
	import { Popover, PopoverContent, PopoverTrigger } from '$lib/components/ui/popover';
	const initialNotifications = [
		{
			action: 'requested review on',
			id: 1,
			target: 'PR #42: Feature implementation',
			timestamp: '15 minutes ago',
			unread: true,
			user: 'Chris Tompson'
		},
		{
			action: 'shared PR',
			id: 2,
			target: 'New component library',
			timestamp: '45 minutes ago',
			unread: true,
			user: 'Emma Davis'
		},
		{
			action: 'assigned you to',
			id: 3,
			target: 'API integration task',
			timestamp: '4 hours ago',
			unread: false,
			user: 'James Wilson'
		},
		{
			action: 'replied to your comment in',
			id: 4,
			target: 'Authentication flow',
			timestamp: '12 hours ago',
			unread: false,
			user: 'Alex Morgan'
		},
		{
			action: 'commented on',
			id: 5,
			target: 'Dashboard redesign',
			timestamp: '2 days ago',
			unread: false,
			user: 'Sarah Chen'
		},
		{
			action: 'mentioned you in',
			id: 6,
			target: 'Origin UI open graph image',
			timestamp: '2 weeks ago',
			unread: false,
			user: 'Miky Derya'
		}
	];

	const notifications = $state(initialNotifications);
	const unreadCount = $derived(notifications.filter((n) => n.unread).length);

	function handleMarkAllAsRead() {
		notifications.forEach((n) => (n.unread = false));
	}

	function handleNotificationClick(notificationId: number) {
		notifications.map((n) => {
			if (n.id === notificationId) {
				n.unread = false; // Mark as read
			}
			return n;
		});
	}
</script>

<Popover>
	<PopoverTrigger>
		{#snippet child({ props })}
			<Button
				size="icon"
				variant="ghost"
				class="size- relative cursor-pointer rounded-full text-zinc-100 shadow-none hover:bg-zinc-600 hover:text-zinc-100"
				aria-label="Open notifications"
				{...props}
			>
				<BellIcon size={16} aria-hidden="true" />

				{#if unreadCount > 0}
					<div
						aria-hidden="true"
						class="absolute top-0.5 right-0.5 size-1 rounded-full bg-green-300"
					></div>
				{/if}
			</Button>
		{/snippet}
	</PopoverTrigger>
	<PopoverContent class="w-80 bg-zinc-700 p-1 text-white">
		<div class="flex items-baseline justify-between gap-4 px-3 py-2">
			<div class="text-sm font-semibold">Notifications</div>
			{#if unreadCount > 0}
				<button
					class="cursor-pointer text-xs font-medium hover:underline"
					onclick={handleMarkAllAsRead}
				>
					Mark all as read
				</button>
			{/if}
		</div>
		<div role="separator" aria-orientation="horizontal" class="-mx-1 my-1 h-px bg-zinc-600"></div>
		{#each notifications as notification (notification.id)}
			<div class="rounded-md px-3 py-2 text-sm transition-colors hover:bg-zinc-600">
				<div class="relative flex items-start pe-3">
					<div class="flex-1 space-y-1">
						<button
							class="cursor-pointer text-left text-zinc-100 after:absolute after:inset-0"
							onclick={() => handleNotificationClick(notification.id)}
						>
							<span class="font-medium text-zinc-100 hover:underline">
								{notification.user}
							</span>
							{notification.action}
							<span class="font-medium text-zinc-100 hover:underline">
								{notification.target}
							</span>
							.
						</button>
						<div class="text-xs text-zinc-300">
							{notification.timestamp}
						</div>
					</div>
					{#if notification.unread}
						<div class="absolute end-0 self-center">
							<span class="sr-only">Unread</span>
							{@render Dot({})}
						</div>
					{/if}
				</div>
			</div>
		{/each}
	</PopoverContent>
</Popover>

{#snippet Dot({ className }: { className?: ClassValue })}
	<svg
		width="6"
		height="6"
		fill="#86efac"
		viewBox="0 0 6 6"
		xmlns="http://www.w3.org/2000/svg"
		class={className}
		aria-hidden="true"
	>
		<circle cx="3" cy="3" r="3" />
	</svg>
{/snippet}
